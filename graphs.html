<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Queue History Graph</title>
   <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   <style>
    h1 {
        margin-left: 15px;
        color: rgb(81, 81, 81); 
    }

    body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
    }

    .dropdown-container {
        position: fixed;
        top: 25;
        width: 100%;
        background-color: none;
        padding: 5px;
        z-index: 100;
        text-align: left;
        margin-left: 10px;
    }

    #class-selector {
        padding: 10px;
        margin: 0;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 16px;
        background-color: white;
        color: #333;
        width: 220px;
        appearance: none;
        cursor: pointer;
        text-align: center;
        outline: none;
    }

    #class-selector:hover {
        background-color: #e6e6f2;
        border-color: #21248e;
    }

    #class-selector option {
        padding: 10px;
        background-color: #fff;
        color: #21248e;
        font-size: 16px;
    }

    .view-toggle {
        display: none;
        margin-left: 10px;
        margin-top: 10px;
    }

    .view-toggle button {
        padding: 8px 16px;
        margin-right: 10px;
        border: 1px solid #21248e;
        border-radius: 5px;
        background-color: white;
        color: #21248e;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .view-toggle button.active {
        background-color: #21248e;
        color: white;
    }

    .view-toggle button:hover {
        background-color: #e6e6f2;
    }
</style>
</head>
<body>
    <div id="header"></div>

    <h1>Queue History</h1>
    <div class="dropdown-container">
        <select id="class-selector" placeholder="Select Class">
            <option value="" disabled selected>Select Class</option>
            <option value="queues">CS 100</option>
            <option value="queue2">CS 107</option>
            <option value="queue4">Class 3</option>
        </select>
        <div class="view-toggle" id="view-toggle">
            <button id="daily-btn" class="active">Today</button>
            <button id="weekly-btn">Week</button>
        </div>
    </div>
    <canvas id="time-spent-chart" width="800" height="400"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBXaPIq6nfeQa2qETjLPt379-TIMd_Oz8o",
            authDomain: "database1-53083.firebaseapp.com",
            projectId: "database1-53083",
            storageBucket: "database1-53083.appspot.com",
            messagingSenderId: "862586413669",
            appId: "1:862586413669:web:71beb08bde5ae8df9adc8c",
            measurementId: "G-DHSPFQRQYR"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const classSelector = document.getElementById('class-selector');
        const chartCanvas = document.getElementById('time-spent-chart');
        const viewToggle = document.getElementById('view-toggle');
        const dailyBtn = document.getElementById('daily-btn');
        const weeklyBtn = document.getElementById('weekly-btn');
        let chartInstance;
        let currentClass = '';
        let currentView = 'daily';

        async function fetchDataAndPlot(classPath, view) {
            const docName = view === 'daily' ? 'TAestimate' : 'weeklyTAestimate';
            const queueDocRef = doc(db, classPath, docName);
            const docSnap = await getDoc(queueDocRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                let timeData, labels;

                if (view === 'daily') {
                    timeData = data.totalTimeSpent || [];
                    labels = timeData.map((_, index) => `Student ${index + 1}`);
                } else {
                    timeData = data.timePerDay || [];
                    const studentsPerDay = data.studentsPerDay || [];
                    labels = timeData.map((_, index) => `Day ${index + 1} (${studentsPerDay[index] || 0} students)`);
                }

                const timeInMinutes = timeData.map(seconds => (seconds / 60).toFixed(2));
                const estimate = (data.estimate || 0) / 60;

                const config = {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: view === 'daily' ? 'Time per Student (minutes)' : 'Average Time per Day (minutes)',
                            data: timeInMinutes,
                            backgroundColor: 'rgba(8, 29, 115, 0.300)',
                            borderColor: 'rgba(8, 29, 115, 0.693)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' },
                            title: { 
                                display: true, 
                                text: view === 'daily' ? 'Time Spent Per Student' : 'Average Time Spent Per Day'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Time (minutes)' }
                            },
                            x: {
                                title: { 
                                    display: true, 
                                    text: view === 'daily' ? 'Students' : 'Days'
                                }
                            }
                        }
                    }
                };

                if (chartInstance) {
                    chartInstance.destroy();
                }

                chartInstance = new Chart(chartCanvas.getContext('2d'), config);
            } else {
                console.log(`No data found for ${classPath}/${docName}`);
            }
        }

        classSelector.addEventListener('change', (e) => {
            currentClass = e.target.value;
            if (currentClass) {
                viewToggle.style.display = 'block';
                fetchDataAndPlot(currentClass, currentView);
            } else {
                viewToggle.style.display = 'none';
            }
        });

        dailyBtn.addEventListener('click', () => {
            if (currentView !== 'daily') {
                currentView = 'daily';
                dailyBtn.classList.add('active');
                weeklyBtn.classList.remove('active');
                if (currentClass) {
                    fetchDataAndPlot(currentClass, currentView);
                }
            }
        });

        weeklyBtn.addEventListener('click', () => {
            if (currentView !== 'weekly') {
                currentView = 'weekly';
                weeklyBtn.classList.add('active');
                dailyBtn.classList.remove('active');
                if (currentClass) {
                    fetchDataAndPlot(currentClass, currentView);
                }
            }
        });
    </script>

    <!-- javascript for header -->
    <script>
        fetch('header.html')
        .then(response => response.text())
        .then(data => {
            document.getElementById('header').innerHTML = data;
    
            const searchInput = document.getElementById('searchInput');
            const searchIcon = document.getElementById('searchIcon');
            const closeIcon = document.getElementById('closeIcon');
    
            // search bar toggle
            function toggleSearchBar() {
                const isActive = searchInput.classList.contains('active');
    
                if (isActive) {
                    searchInput.classList.remove('active');
                    searchIcon.style.display = 'inline';
                    closeIcon.style.display = 'none';
                } else {
                    searchInput.classList.add('active');
                    searchIcon.style.display = 'none';
                    closeIcon.style.display = 'inline';
                    searchInput.focus();
                }
            }
    
            // event listeners
            searchIcon.addEventListener('click', toggleSearchBar);
            closeIcon.addEventListener('click', toggleSearchBar);
    
            // redirect on enter
            searchInput.addEventListener('keydown', function (event) {
                if (event.key === 'Enter') {
                    const inputValue = searchInput.value;
                    if (inputValue) {
                        const encodedVal = encodeURIComponent(inputValue);
                        window.location.href = `search.html?input=${encodedVal}`;
                    }
                }
            });
        })
        .catch(error => console.error('Header loading error:', error));
    </script>
</body>
</html>