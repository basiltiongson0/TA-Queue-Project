<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Queue History Graph</title>
   <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   <style>
    h1 {
        margin-left: 15px;
        color: rgb(81, 81, 81); 
    }

    body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
    }

    .dropdown-container {
        position: fixed; 
        top: 25; /* at the top of the page */
        width: 100%; /* width of the page */
        background-color: none; 
        padding: 5px;
        /* box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);  */
        z-index: 100; /* stay above all content */
        text-align: left; 
        margin-left: 10px; 
    }

    #class-selector {
        padding: 10px;
        margin: 0; 
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 16px;
        background-color: white;
        color: #333; /* text color */ 
        width: 220px;
        appearance: none;
        cursor: pointer;
        text-align: center;
    }

    #class-selector:hover {
        background-color: #e6e6f2;
        border-color: #21248e;
    }

    #class-selector option {
        padding: 10px;
        background-color: #fff;
        color: #21248e;
        font-size: 16px;
    }

</style>
</head>
<body>
    <div id="header"></div>

   <h1>Queue History</h1>
   <div class="dropdown-container">
    <select id="class-selector" placeholder="Select Class">
        <option value="" disabled selected>Select Class</option>
        <option value="queues/TAestimate">CS 100</option>
        <option value="queue2/TAestimate">CS 107</option>
        <option value="queue4/TAestimate">Class 3</option>
    </select>
    </div>
   <canvas id="time-spent-chart" width="800" height="400"></canvas>

   <script type="module">
       import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-app.js";
       import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-firestore.js";

       const firebaseConfig = {
           apiKey: "AIzaSyBXaPIq6nfeQa2qETjLPt379-TIMd_Oz8o",
           authDomain: "database1-53083.firebaseapp.com",
           projectId: "database1-53083",
           storageBucket: "database1-53083.appspot.com",
           messagingSenderId: "862586413669",
           appId: "1:862586413669:web:71beb08bde5ae8df9adc8c",
           measurementId: "G-DHSPFQRQYR"
       };

       const app = initializeApp(firebaseConfig);
       const db = getFirestore(app);

       const classSelector = document.getElementById('class-selector');
       const chartCanvas = document.getElementById('time-spent-chart');
       let chartInstance;

       async function fetchDataAndPlot(classPath) {
           const queueDocRef = doc(db, ...classPath.split('/'));
           const docSnap = await getDoc(queueDocRef);

           if (docSnap.exists()) {
               const totalTimeSpent = docSnap.data().totalTimeSpent || [];
               const estimate = docSnap.data().estimate || 0;

               const totalTimeSpentInMinutes = totalTimeSpent.map(seconds => (seconds / 60).toFixed(2));
               const estimateInMinutes = (estimate / 60).toFixed(2);
               const labels = totalTimeSpent.map((_, index) => `Student ${index + 1}`);
               const data = totalTimeSpentInMinutes;

               const config = {
                   type: 'bar',
                   data: {
                       labels: labels,
                       datasets: [{
                           label: 'Time Spent (minutes)',
                           data: data,
                           backgroundColor: 'rgba(8, 29, 115, 0.300)',
                           borderColor: 'rgba(8, 29, 115, 0.693)',
                           borderWidth: 1
                       }]
                   },
                   options: {
                       responsive: true,
                       plugins: {
                           legend: { position: 'top' },
                           title: { display: true, text: 'Time Spent Per Student' },
                           annotation: {
                               annotations: {
                                   estimateLine: {
                                       type: 'line',
                                       yMin: estimateInMinutes,
                                       yMax: estimateInMinutes,
                                       borderColor: 'red',
                                       borderWidth: 2,
                                       label: {
                                           display: true,
                                           content: `Estimated Time (${estimateInMinutes} minutes)`,
                                           position: 'end',
                                           backgroundColor: 'rgba(255, 99, 132, 0.8)',
                                           color: '#fff',
                                           font: { weight: 'bold' }
                                       }
                                   }
                               }
                           }
                       },
                       scales: {
                           y: {
                               beginAtZero: true,
                               title: { display: true, text: 'Time (minutes)' }
                           },
                           x: {
                               title: { display: true, text: 'Students' }
                           }
                       }
                   }
               };

               if (chartInstance) {
                   chartInstance.destroy();
               }

               chartInstance = new Chart(chartCanvas.getContext('2d'), config);
           } else {
               console.log(`No data found for ${classPath}.`);
           }
       }

       classSelector.addEventListener('change', (e) => {
           fetchDataAndPlot(e.target.value);
       });

       fetchDataAndPlot(classSelector.value);
   </script>
</body>
</html>

    <!-- javascript to load header -->
    <script>
        fetch('header.html')
        .then(response => response.text())
        .then(data => {
            document.getElementById('header').innerHTML = data;
    
            const searchInput = document.getElementById('searchInput');
            const searchIcon = document.getElementById('searchIcon');
            const closeIcon = document.getElementById('closeIcon');
    
            // search bar toggle
            function toggleSearchBar() {
                const isActive = searchInput.classList.contains('active');
    
                if (isActive) {
                    searchInput.classList.remove('active');
                    searchIcon.style.display = 'inline';
                    closeIcon.style.display = 'none';
                } else {
                    searchInput.classList.add('active');
                    searchIcon.style.display = 'none';
                    closeIcon.style.display = 'inline';
                    searchInput.focus();
                }
            }
    
            // event listeners
            searchIcon.addEventListener('click', toggleSearchBar);
            closeIcon.addEventListener('click', toggleSearchBar);
    
            // redirect on enter
            searchInput.addEventListener('keydown', function (event) {
                if (event.key === 'Enter') {
                    const inputValue = searchInput.value;
                    if (inputValue) {
                        const encodedVal = encodeURIComponent(inputValue);
                        window.location.href = `search.html?input=${encodedVal}`;
                    }
                }
            });
        })
        .catch(error => console.error('Header loading error:', error));
    </script>
</html>
